<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Evaluasi Building Management OJK DIY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        .upload-zone {
            border: 3px dashed #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.1);
        }
        .upload-zone.dragover {
            border-color: #1d4ed8;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: translateY(-4px);
            box-shadow: 0 25px 50px rgba(29, 78, 216, 0.2);
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .chart-container { 
            position: relative; 
            height: 350px; 
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 shadow-2xl">
        <div class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4">
                        <i class="fas fa-building text-3xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">Dashboard Evaluasi Building Management</h1>
                        <p class="text-blue-100 text-lg flex items-center">
                            <i class="fas fa-university mr-3"></i>
                            Otoritas Jasa Keuangan - Daerah Istimewa Yogyakarta
                        </p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button id="exportBtn" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-3" disabled>
                        <i class="fas fa-file-pdf text-xl"></i>
                        <span>Download Laporan PDF</span>
                    </button>
                    <button id="refreshBtn" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 flex items-center space-x-3">
                        <i class="fas fa-sync-alt text-xl"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Upload Section -->
        <div id="uploadSection" class="glass-card rounded-3xl p-8 mb-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4">
                    <i class="fas fa-cloud-upload-alt text-3xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold gradient-text mb-2">Import Data Evaluasi</h2>
                <p class="text-gray-600 text-lg">Upload file CSV/Excel atau masukkan URL untuk memulai analisis</p>
            </div>

            <!-- URL Input -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-700 mb-4">
                    <i class="fas fa-link mr-2 text-blue-500"></i>
                    URL Data (Google Sheets, CSV, dll)
                </label>
                <div class="flex space-x-4">
                    <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/..." 
                           class="flex-1 px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-lg">
                    <button id="loadUrlBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 flex items-center space-x-3">
                        <i class="fas fa-download"></i>
                        <span>Load Data</span>
                    </button>
                </div>
            </div>

            <div class="flex items-center mb-6">
                <div class="flex-1 h-px bg-gray-300"></div>
                <span class="px-6 text-gray-500 font-semibold text-lg">ATAU</span>
                <div class="flex-1 h-px bg-gray-300"></div>
            </div>

            <!-- File Upload -->
            <div class="upload-zone rounded-3xl p-12 text-center cursor-pointer" id="uploadZone">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-6">
                        <i class="fas fa-file-upload text-3xl text-white"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-gray-700 mb-3">Drag & Drop File di Sini</h3>
                <p class="text-gray-600 mb-6 text-lg">atau klik untuk memilih file</p>
                <button class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-10 py-4 rounded-2xl font-semibold transition-all duration-300 flex items-center space-x-3 mx-auto">
                    <i class="fas fa-folder-open text-xl"></i>
                    <span>Pilih File</span>
                </button>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden">
                <p class="text-gray-500 mt-6 flex items-center justify-center text-lg">
                    <i class="fas fa-info-circle mr-2"></i>
                    Format: CSV, XLSX, XLS (Max: 10MB)
                </p>
            </div>

            <!-- File Status -->
            <div id="fileStatus" class="mt-8 hidden">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 text-2xl mr-4"></i>
                        <div>
                            <p class="text-green-800 font-bold text-lg">File berhasil dimuat: <span id="fileName"></span></p>
                            <p class="text-green-600">Total data: <span id="dataCount"></span> responden</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loadingStatus" class="mt-8 hidden">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6">
                    <div class="flex items-center">
                        <div class="loading-spinner mr-4"></div>
                        <div>
                            <p class="text-blue-800 font-bold text-lg">Memproses data...</p>
                            <p class="text-blue-600">Mohon tunggu sebentar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Start -->
            <div class="mt-8 text-center">
                <button id="sampleBtn" class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 flex items-center space-x-3 mx-auto">
                    <i class="fas fa-rocket"></i>
                    <span>Coba dengan Data Contoh</span>
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-8">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Total Responden</p>
                            <p class="text-4xl font-bold text-gray-900" id="totalResponden">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-4">
                            <i class="fas fa-users text-2xl text-white"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Rating Rata-rata</p>
                            <p class="text-4xl font-bold text-gray-900" id="avgRating">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-4">
                            <i class="fas fa-star text-2xl text-white"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Responden Internal</p>
                            <p class="text-4xl font-bold text-gray-900" id="internalCount">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-4">
                            <i class="fas fa-user-tie text-2xl text-white"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">Responden Eksternal</p>
                            <p class="text-4xl font-bold text-gray-900" id="externalCount">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-2xl p-4">
                            <i class="fas fa-user-friends text-2xl text-white"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-3 mr-4">
                            <i class="fas fa-chart-bar text-xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Distribusi Rating</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="ratingChart"></canvas>
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-gradient-to-r from-pink-500 to-rose-600 rounded-2xl p-3 mr-4">
                            <i class="fas fa-chart-pie text-xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Komposisi Responden</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Division Rankings -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-3 mr-4">
                            <i class="fas fa-building text-xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Ranking Divisi</h3>
                    </div>
                    <div id="divisionRanking" class="space-y-4"></div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-600 rounded-2xl p-3 mr-4">
                            <i class="fas fa-clock text-xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Responden Tercepat</h3>
                    </div>
                    <div id="fastestResponders" class="space-y-4"></div>
                </div>
            </div>

            <!-- Rankings -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-600 rounded-2xl p-3 mr-4">
                            <i class="fas fa-trophy text-xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Top Responden Internal</h3>
                    </div>
                    <div id="internalRanking" class="space-y-4"></div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-3 mr-4">
                            <i class="fas fa-medal text-xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Top Responden Eksternal</h3>
                    </div>
                    <div id="externalRanking" class="space-y-4"></div>
                </div>
            </div>

            <!-- Low Performance Analysis -->
            <div class="glass-card rounded-3xl p-8">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-2xl p-3 mr-4">
                        <i class="fas fa-exclamation-triangle text-xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">Evaluasi Divisi dengan Nilai Terendah</h3>
                </div>
                <div id="lowPerformanceAnalysis" class="space-y-4"></div>
            </div>

            <!-- Analysis -->
            <div class="glass-card rounded-3xl p-8">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl p-3 mr-4">
                        <i class="fas fa-chart-line text-xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">Analisis & Rekomendasi</h3>
                </div>
                <div id="analysisContent" class="prose max-w-none"></div>
            </div>

            <!-- Feedback Section -->
            <div class="glass-card rounded-3xl p-8">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-3 mr-4">
                        <i class="fas fa-comments text-xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">Kritik & Saran Responden</h3>
                </div>
                <div id="feedbackContent" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let charts = {};

        // Elements
        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const csvUrlInput = document.getElementById('csvUrl');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const sampleBtn = document.getElementById('sampleBtn');
        const exportBtn = document.getElementById('exportBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const fileStatus = document.getElementById('fileStatus');
        const loadingStatus = document.getElementById('loadingStatus');
        const dashboardContent = document.getElementById('dashboardContent');

        // Event Listeners
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        loadUrlBtn.addEventListener('click', loadFromUrl);
        sampleBtn.addEventListener('click', loadSampleData);
        exportBtn.addEventListener('click', exportToPDF);
        refreshBtn.addEventListener('click', refreshDashboard);

        // Drag & Drop Handlers
        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        }

        // File Processing
        function processFile(file) {
            console.log('Processing file:', file.name, file.type, file.size);
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File terlalu besar! Maksimal 10MB.');
                return;
            }

            const extension = file.name.split('.').pop().toLowerCase();
            if (!['csv', 'xlsx', 'xls'].includes(extension)) {
                alert('Format file tidak didukung! Gunakan CSV, XLSX, atau XLS.');
                return;
            }

            showLoading();

            if (extension === 'csv') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        parseCSV(e.target.result);
                        showSuccess(file.name);
                    } catch (error) {
                        showError('Error parsing CSV: ' + error.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const csv = XLSX.utils.sheet_to_csv(firstSheet);
                        parseCSV(csv);
                        showSuccess(file.name);
                    } catch (error) {
                        showError('Error parsing Excel: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // URL Loading
        async function loadFromUrl() {
            const url = csvUrlInput.value.trim();
            if (!url) {
                alert('Masukkan URL terlebih dahulu!');
                return;
            }

            showLoading();

            try {
                let csvUrl = url;
                
                // Convert Google Sheets URL
                if (url.includes('docs.google.com/spreadsheets')) {
                    const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (match) {
                        csvUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv`;
                    }
                }

                // Try multiple CORS proxies
                const proxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/',
                    ''
                ];

                let success = false;
                for (const proxy of proxies) {
                    try {
                        const response = await fetch(proxy + encodeURIComponent(csvUrl));
                        if (response.ok) {
                            const csvText = await response.text();
                            parseCSV(csvText);
                            showSuccess('Data dari URL');
                            success = true;
                            break;
                        }
                    } catch (error) {
                        continue;
                    }
                }

                if (!success) {
                    throw new Error('Tidak dapat memuat data dari URL');
                }

            } catch (error) {
                showError('Gagal memuat data: ' + error.message);
            }
        }

        // Sample Data
        function loadSampleData() {
            const sampleCSV = `Timestamp,Nama,Division,Instansi,Type,Rating,Reason,Feedback Umum
2024-01-15 08:30:00,Ahmad Wijaya,IT,OJK DIY,Internal,4.5,"Pelayanan sangat baik dan responsif","Terus tingkatkan kualitas pelayanan teknologi"
2024-01-15 08:45:00,Siti Nurhaliza,Keuangan,OJK DIY,Internal,4.2,"Staff ramah dan profesional","Perlu peningkatan di area kebersihan toilet"
2024-01-15 09:00:00,Budi Santoso,Operasional,OJK DIY,Internal,3.8,"Cukup baik tapi masih ada yang perlu diperbaiki","Sistem AC di lantai 2 perlu diperbaiki segera"
2024-01-15 09:15:00,Dr. Maya Sari,Akademisi,Universitas Gadjah Mada,External,4.0,"Fasilitas lengkap dan memadai","Area parkir perlu diperluas untuk tamu"
2024-01-15 09:30:00,Eko Prasetyo,Pengawasan,OJK DIY,Internal,3.5,"Pelayanan standar","Perlu pelatihan customer service yang lebih baik"
2024-01-15 09:45:00,Lisa Permata,Hukum,OJK DIY,Internal,4.8,"Excellent service, very satisfied","Keep up the good work, semua sudah baik"
2024-01-15 10:00:00,Rudi Hartono,Konsultan,PT Mandiri Konsultan,External,3.2,"Kurang responsif dalam menangani keluhan","Perlu sistem complaint yang lebih efektif"
2024-01-15 10:15:00,Indira Sari,Komunikasi,OJK DIY,Internal,4.1,"Baik secara keseluruhan","Tingkatkan koordinasi antar divisi"
2024-01-15 10:30:00,Prof. Bambang,Peneliti,LIPI,External,4.3,"Fasilitas penelitian sangat mendukung","Akses internet perlu dipercepat di ruang meeting"
2024-01-15 10:45:00,Dewi Lestari,SDM,OJK DIY,Internal,2.8,"Banyak hal yang perlu diperbaiki","Sistem booking ruangan tidak user-friendly"
2024-01-15 11:00:00,Agus Setiawan,IT,OJK DIY,Internal,4.6,"Infrastruktur IT sangat baik","Maintenance rutin server perlu dijadwalkan"
2024-01-15 11:15:00,Maria Santos,Auditor,KAP Santos & Partners,External,3.9,"Cukup memuaskan","Ruang meeting perlu sound system yang lebih baik"
2024-01-15 11:30:00,Hendra Kusuma,Pemasaran,OJK DIY,Internal,3.1,"Masih banyak kekurangan","Staff security perlu training komunikasi"
2024-01-15 11:45:00,Dr. Ratna,Konsultan,Konsultan Independen,External,4.4,"Pelayanan profesional","Sistem keamanan sudah sangat baik"
2024-01-15 12:00:00,Yudi Pratama,Administrasi,OJK DIY,Internal,3.7,"Cukup baik tapi bisa lebih baik","Proses administrasi perlu disederhanakan"
2024-01-15 12:15:00,Rina Sari,Keuangan,OJK DIY,Internal,2.5,"Pelayanan kurang memuaskan","Lift sering bermasalah, perlu perbaikan"
2024-01-15 12:30:00,Doni Prasetyo,Operasional,OJK DIY,Internal,3.0,"Standar saja","Kantin perlu variasi menu yang lebih banyak"
2024-01-15 12:45:00,Fitri Handayani,SDM,OJK DIY,Internal,2.9,"Masih perlu banyak perbaikan","Toilet wanita sering kotor dan tidak terawat"
2024-01-15 13:00:00,Joko Widodo,Pengawasan,OJK DIY,Internal,4.0,"Cukup baik","Parkir motor perlu area yang lebih luas"
2024-01-15 13:15:00,Sari Dewi,Komunikasi,OJK DIY,Internal,3.6,"Lumayan baik","Sinyal wifi di beberapa area masih lemah"`;
            
            try {
                parseCSV(sampleCSV);
                showSuccess('Data Contoh');
            } catch (error) {
                showError('Error loading sample data: ' + error.message);
            }
        }

        // CSV Parser
        function parseCSV(csv) {
            const lines = csv.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('File CSV harus memiliki minimal header dan 1 baris data');
            }

            const headers = parseCSVLine(lines[0]);
            currentData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length > 0) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    currentData.push(row);
                }
            }

            if (currentData.length === 0) {
                throw new Error('Tidak ada data valid ditemukan');
            }

            updateDashboard();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.replace(/^"|"$/g, ''));
            return result;
        }

        // UI State Management
        function showLoading() {
            loadingStatus.classList.remove('hidden');
            fileStatus.classList.add('hidden');
        }

        function showSuccess(fileName) {
            loadingStatus.classList.add('hidden');
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('dataCount').textContent = currentData.length;
            fileStatus.classList.remove('hidden');
            dashboardContent.classList.remove('hidden');
            exportBtn.disabled = false;
        }

        function showError(message) {
            loadingStatus.classList.add('hidden');
            alert(message);
        }

        // Dashboard Updates
        function updateDashboard() {
            updateStatistics();
            updateCharts();
            updateDivisionRanking();
            updateFastestResponders();
            updateRankings();
            updateLowPerformanceAnalysis();
            updateAnalysis();
            updateFeedback();
        }

        function updateStatistics() {
            const total = currentData.length;
            const ratings = currentData.map(d => parseFloat(d.Rating)).filter(r => !isNaN(r));
            const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 0;
            const internal = currentData.filter(d => d.Type && d.Type.toLowerCase().includes('internal')).length;
            const external = total - internal;

            document.getElementById('totalResponden').textContent = total;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('internalCount').textContent = internal;
            document.getElementById('externalCount').textContent = external;
        }

        function updateCharts() {
            // Rating Distribution Chart
            const ratings = currentData.map(d => parseFloat(d.Rating)).filter(r => !isNaN(r));
            const ratingCounts = {};
            for (let i = 1; i <= 5; i++) {
                ratingCounts[i] = ratings.filter(r => Math.floor(r) === i).length;
            }

            if (charts.ratingChart) charts.ratingChart.destroy();
            const ratingCtx = document.getElementById('ratingChart').getContext('2d');
            charts.ratingChart = new Chart(ratingCtx, {
                type: 'bar',
                data: {
                    labels: ['Rating 1', 'Rating 2', 'Rating 3', 'Rating 4', 'Rating 5'],
                    datasets: [{
                        label: 'Jumlah Responden',
                        data: [ratingCounts[1], ratingCounts[2], ratingCounts[3], ratingCounts[4], ratingCounts[5]],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ],
                        borderColor: [
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(34, 197, 94, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 12,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { family: 'Inter', size: 12 }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { font: { family: 'Inter', size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Type Distribution Chart
            const internal = currentData.filter(d => d.Type && d.Type.toLowerCase().includes('internal')).length;
            const external = currentData.length - internal;

            if (charts.typeChart) charts.typeChart.destroy();
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            charts.typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Internal', 'Eksternal'],
                    datasets: [{
                        data: [internal, external],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ],
                        borderColor: [
                            'rgba(99, 102, 241, 1)',
                            'rgba(236, 72, 153, 1)'
                        ],
                        borderWidth: 3,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: 'Inter', size: 14 },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8
                        }
                    }
                }
            });
        }

        function updateDivisionRanking() {
            const divisionData = {};
            
            currentData.forEach(d => {
                if (d.Division && d.Type && d.Type.toLowerCase().includes('internal')) {
                    const division = d.Division.trim();
                    if (!divisionData[division]) {
                        divisionData[division] = {
                            name: division,
                            ratings: [],
                            internal: 0,
                            external: 0
                        };
                    }
                    const rating = parseFloat(d.Rating);
                    if (!isNaN(rating)) {
                        divisionData[division].ratings.push(rating);
                        divisionData[division].internal++;
                    }
                }
            });

            const divisionRanking = Object.values(divisionData)
                .map(div => ({
                    ...div,
                    avgRating: div.ratings.length > 0 ? 
                        div.ratings.reduce((a, b) => a + b, 0) / div.ratings.length : 0,
                    totalResponses: div.ratings.length
                }))
                .sort((a, b) => b.avgRating - a.avgRating);

            const container = document.getElementById('divisionRanking');
            container.innerHTML = '';

            if (divisionRanking.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Tidak ada data divisi untuk ditampilkan</p>
                    </div>
                `;
                return;
            }

            divisionRanking.forEach((division, index) => {
                const rankClass = index === 0 ? 'bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-300' : 
                                 index === 1 ? 'bg-gradient-to-r from-gray-50 to-slate-50 border-gray-300' : 
                                 index === 2 ? 'bg-gradient-to-r from-orange-50 to-red-50 border-orange-300' : 'bg-white border-gray-200';
                
                const medal = index === 0 ? '<i class="fas fa-trophy text-yellow-500 text-xl"></i>' : 
                             index === 1 ? '<i class="fas fa-medal text-gray-400 text-xl"></i>' : 
                             index === 2 ? '<i class="fas fa-award text-orange-500 text-xl"></i>' : 
                             `<span class="text-xl font-bold text-gray-600">${index + 1}</span>`;

                container.innerHTML += `
                    <div class="flex items-center justify-between p-6 rounded-2xl border-2 ${rankClass} transition-all duration-300 hover:shadow-lg hover:scale-105">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 flex items-center justify-center">
                                ${medal}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-lg">${division.name}</p>
                                <p class="text-gray-600 flex items-center">
                                    <i class="fas fa-users mr-2"></i>
                                    ${division.totalResponses} responden
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-2xl text-blue-600">${division.avgRating.toFixed(1)}</p>
                            <p class="text-sm text-gray-500">Rating Rata-rata</p>
                        </div>
                    </div>
                `;
            });
        }

        function updateFastestResponders() {
            const sortedByTime = currentData
                .filter(d => d.Timestamp && d.Type && d.Type.toLowerCase().includes('internal'))
                .sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp))
                .slice(0, 8);

            const container = document.getElementById('fastestResponders');
            container.innerHTML = '';

            if (sortedByTime.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Tidak ada data waktu respons</p>
                    </div>
                `;
                return;
            }

            sortedByTime.forEach((responder, index) => {
                const time = new Date(responder.Timestamp);
                const timeString = time.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const speedClass = index < 3 ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-300' : 'bg-white border-gray-200';
                const speedIcon = index < 3 ? '<i class="fas fa-bolt text-green-600 text-xl"></i>' : '<i class="fas fa-clock text-gray-500 text-xl"></i>';

                container.innerHTML += `
                    <div class="flex items-center justify-between p-6 rounded-2xl border-2 ${speedClass} transition-all duration-300 hover:shadow-lg hover:scale-105">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 flex items-center justify-center">
                                ${speedIcon}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-lg">${responder.Nama}</p>
                                <p class="text-gray-600 flex items-center">
                                    <i class="fas fa-building mr-2"></i>
                                    ${responder.Division}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-blue-600">${timeString}</p>
                            <p class="text-sm text-gray-500">Waktu Respons</p>
                        </div>
                    </div>
                `;
            });
        }

        function updateRankings() {
            // Internal ranking
            const internalData = currentData.filter(d => d.Type && d.Type.toLowerCase().includes('internal'));
            const internalRanking = calculateRanking(internalData);
            displayRanking('internalRanking', internalRanking);

            // External ranking
            const externalData = currentData.filter(d => d.Type && !d.Type.toLowerCase().includes('internal'));
            const externalRanking = calculateRanking(externalData);
            displayRanking('externalRanking', externalRanking);
        }

        function calculateRanking(data) {
            const grouped = {};
            data.forEach(d => {
                const name = d.Nama || 'Unknown';
                if (!grouped[name]) {
                    grouped[name] = {
                        name: name,
                        ratings: [],
                        instansi: d.Instansi || '',
                        division: d.Division || ''
                    };
                }
                const rating = parseFloat(d.Rating);
                if (!isNaN(rating)) {
                    grouped[name].ratings.push(rating);
                }
            });

            return Object.values(grouped)
                .map(person => ({
                    ...person,
                    avgRating: person.ratings.length > 0 ? 
                        person.ratings.reduce((a, b) => a + b, 0) / person.ratings.length : 0,
                    totalResponses: person.ratings.length
                }))
                .sort((a, b) => b.avgRating - a.avgRating)
                .slice(0, 8);
        }

        function displayRanking(containerId, ranking) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (ranking.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Tidak ada data untuk ditampilkan</p>
                    </div>
                `;
                return;
            }

            ranking.forEach((person, index) => {
                const rankClass = index === 0 ? 'bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-300' : 
                                 index === 1 ? 'bg-gradient-to-r from-gray-50 to-slate-50 border-gray-300' : 
                                 index === 2 ? 'bg-gradient-to-r from-orange-50 to-red-50 border-orange-300' : 'bg-white border-gray-200';
                
                const medal = index === 0 ? '<i class="fas fa-trophy text-yellow-500 text-xl"></i>' : 
                             index === 1 ? '<i class="fas fa-medal text-gray-400 text-xl"></i>' : 
                             index === 2 ? '<i class="fas fa-award text-orange-500 text-xl"></i>' : 
                             `<span class="text-xl font-bold text-gray-600">${index + 1}</span>`;

                container.innerHTML += `
                    <div class="flex items-center justify-between p-6 rounded-2xl border-2 ${rankClass} transition-all duration-300 hover:shadow-lg hover:scale-105">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 flex items-center justify-center">
                                ${medal}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-lg">${person.name}</p>
                                <p class="text-gray-600 flex items-center">
                                    <i class="fas fa-building mr-2"></i>
                                    ${person.instansi} ${person.division ? '- ' + person.division : ''}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-2xl text-blue-600">${person.avgRating.toFixed(1)}</p>
                            <p class="text-sm text-gray-500 flex items-center">
                                <i class="fas fa-comment-dots mr-1"></i>
                                ${person.totalResponses} respon
                            </p>
                        </div>
                    </div>
                `;
            });
        }

        function updateLowPerformanceAnalysis() {
            const divisionData = {};
            
            currentData.forEach(d => {
                if (d.Division && d.Type && d.Type.toLowerCase().includes('internal')) {
                    const division = d.Division.trim();
                    if (!divisionData[division]) {
                        divisionData[division] = {
                            name: division,
                            ratings: [],
                            feedback: []
                        };
                    }
                    const rating = parseFloat(d.Rating);
                    if (!isNaN(rating)) {
                        divisionData[division].ratings.push(rating);
                        if (rating < 3.5) {
                            divisionData[division].feedback.push({
                                name: d.Nama,
                                rating: rating,
                                reason: d.Reason || '',
                                feedback: d['Feedback Umum'] || ''
                            });
                        }
                    }
                }
            });

            const lowPerformingDivisions = Object.values(divisionData)
                .map(div => ({
                    ...div,
                    avgRating: div.ratings.length > 0 ? 
                        div.ratings.reduce((a, b) => a + b, 0) / div.ratings.length : 0,
                    totalResponses: div.ratings.length
                }))
                .filter(div => div.avgRating < 3.5)
                .sort((a, b) => a.avgRating - b.avgRating);

            const container = document.getElementById('lowPerformanceAnalysis');
            container.innerHTML = '';

            if (lowPerformingDivisions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-thumbs-up text-5xl text-green-300 mb-4"></i>
                        <p class="text-green-600 text-lg font-semibold">Semua divisi memiliki performa yang baik!</p>
                        <p class="text-gray-500">Tidak ada divisi dengan rating di bawah 3.5</p>
                    </div>
                `;
                return;
            }

            lowPerformingDivisions.forEach((division, index) => {
                container.innerHTML += `
                    <div class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-300 rounded-2xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="bg-red-100 rounded-xl p-3">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-red-800 text-xl">${division.name}</h4>
                                    <p class="text-red-600">Rating: ${division.avgRating.toFixed(1)}/5.0 â¢ ${division.totalResponses} responden</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="bg-red-200 text-red-800 px-4 py-2 rounded-full font-bold">
                                    PERLU PERBAIKAN
                                </span>
                            </div>
                        </div>
                        
                        <div class="bg-white/70 rounded-xl p-4">
                            <h5 class="font-semibold text-gray-800 mb-3">
                                <i class="fas fa-comments mr-2"></i>
                                Feedback Negatif:
                            </h5>
                            <div class="space-y-3">
                                ${division.feedback.slice(0, 3).map(fb => `
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-medium text-gray-800">${fb.name}</span>
                                            <span class="text-red-600 font-bold">${fb.rating.toFixed(1)} â­</span>
                                        </div>
                                        ${fb.reason ? `<p class="text-gray-700 text-sm italic">"${fb.reason}"</p>` : ''}
                                        ${fb.feedback ? `<p class="text-gray-700 text-sm italic">"${fb.feedback}"</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function updateAnalysis() {
            const ratings = currentData.map(d => parseFloat(d.Rating)).filter(r => !isNaN(r));
            const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
            const internal = currentData.filter(d => d.Type && d.Type.toLowerCase().includes('internal')).length;
            const external = currentData.length - internal;
            const lowRatings = ratings.filter(r => r < 3).length;
            const highRatings = ratings.filter(r => r >= 4).length;

            let analysis = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-chart-bar text-blue-600 text-2xl mr-3"></i>
                            <h4 class="font-bold text-blue-800 text-xl">Ringkasan Evaluasi</h4>
                        </div>
                        <p class="text-blue-700 leading-relaxed text-lg">
                            Berdasarkan <strong>${currentData.length} responden</strong>, rating rata-rata building management adalah 
                            <strong>${avgRating.toFixed(1)}/5.0</strong>. Ini menunjukkan 
                            ${avgRating >= 4 ? 'kinerja yang sangat baik' : avgRating >= 3 ? 'kinerja yang cukup baik dengan ruang perbaikan' : 'kinerja yang memerlukan perhatian serius'}.
                        </p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-users text-green-600 text-2xl mr-3"></i>
                            <h4 class="font-bold text-green-800 text-xl">Komposisi Responden</h4>
                        </div>
                        <p class="text-green-700 leading-relaxed text-lg">
                            Evaluasi melibatkan <strong>${internal} responden internal</strong> (${((internal/currentData.length)*100).toFixed(1)}%) 
                            dan <strong>${external} responden eksternal</strong> (${((external/currentData.length)*100).toFixed(1)}%). 
                            Keseimbangan perspektif memberikan gambaran yang komprehensif.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 p-6 rounded-2xl">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-thumbs-up text-purple-600 text-xl mr-3"></i>
                                <h4 class="font-bold text-purple-800">Kepuasan Tinggi</h4>
                            </div>
                            <p class="text-3xl font-bold text-purple-600">${highRatings}</p>
                            <p class="text-purple-700">responden (${((highRatings/ratings.length)*100).toFixed(1)}%)</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 p-6 rounded-2xl">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-exclamation-triangle text-orange-600 text-xl mr-3"></i>
                                <h4 class="font-bold text-orange-800">Perlu Perhatian</h4>
                            </div>
                            <p class="text-3xl font-bold text-orange-600">${lowRatings}</p>
                            <p class="text-orange-700">responden (${((lowRatings/ratings.length)*100).toFixed(1)}%)</p>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 p-6 rounded-2xl">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-lightbulb text-yellow-600 text-2xl mr-3"></i>
                            <h4 class="font-bold text-yellow-800 text-xl">Rekomendasi Perbaikan</h4>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-check-circle text-green-600 mt-1"></i>
                                <p class="text-yellow-700">Perbaikan sistem AC dan ventilasi di seluruh gedung</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-check-circle text-green-600 mt-1"></i>
                                <p class="text-yellow-700">Peningkatan kebersihan dan maintenance toilet</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-check-circle text-green-600 mt-1"></i>
                                <p class="text-yellow-700">Perluasan area parkir untuk kendaraan</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-check-circle text-green-600 mt-1"></i>
                                <p class="text-yellow-700">Pelatihan customer service untuk staff</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-check-circle text-green-600 mt-1"></i>
                                <p class="text-yellow-700">Upgrade infrastruktur IT dan jaringan wifi</p>
                            </div>
                        </div>
                    </div>
            `;

            if (avgRating >= 4.0) {
                analysis += `
                    <div class="bg-gradient-to-r from-green-50 to-teal-50 border-2 border-green-200 p-6 rounded-2xl">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-star text-green-600 text-2xl mr-3"></i>
                            <h4 class="font-bold text-green-800 text-xl">Kinerja Excellent</h4>
                        </div>
                        <p class="text-green-700 leading-relaxed text-lg">
                            Building management menunjukkan kinerja yang excellent. Pertahankan standar pelayanan 
                            yang ada dan terus tingkatkan inovasi dalam pelayanan.
                        </p>
                    </div>
                `;
            } else if (avgRating >= 3.0) {
                analysis += `
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 p-6 rounded-2xl">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-chart-line text-yellow-600 text-2xl mr-3"></i>
                            <h4 class="font-bold text-yellow-800 text-xl">Perlu Optimalisasi</h4>
                        </div>
                        <p class="text-yellow-700 leading-relaxed text-lg">
                            Building management memiliki ruang untuk perbaikan yang signifikan. Fokus pada area 
                            yang mendapat rating rendah dan implementasikan strategi peningkatan kualitas.
                        </p>
                    </div>
                `;
            } else {
                analysis += `
                    <div class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 p-6 rounded-2xl">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-exclamation-circle text-red-600 text-2xl mr-3"></i>
                            <h4 class="font-bold text-red-800 text-xl">Perlu Perbaikan Menyeluruh</h4>
                        </div>
                        <p class="text-red-700 leading-relaxed text-lg">
                            Building management memerlukan perbaikan menyeluruh dan segera. Evaluasi ulang 
                            seluruh prosedur dan implementasikan program perbaikan komprehensif.
                        </p>
                    </div>
                `;
            }

            analysis += '</div>';
            document.getElementById('analysisContent').innerHTML = analysis;
        }

        function updateFeedback() {
            const allFeedback = [];
            
            currentData.forEach(d => {
                const responder = d.Nama || 'Anonim';
                const rating = parseFloat(d.Rating) || 0;
                const division = d.Division || '';
                
                if (d.Reason && d.Reason.trim()) {
                    allFeedback.push({
                        responder: responder,
                        rating: rating,
                        division: division,
                        type: 'Alasan Rating',
                        content: d.Reason.trim(),
                        priority: rating < 3 ? 'high' : rating < 4 ? 'medium' : 'low'
                    });
                }
                
                if (d['Feedback Umum'] && d['Feedback Umum'].trim()) {
                    allFeedback.push({
                        responder: responder,
                        rating: rating,
                        division: division,
                        type: 'Saran Perbaikan',
                        content: d['Feedback Umum'].trim(),
                        priority: rating < 3 ? 'high' : rating < 4 ? 'medium' : 'low'
                    });
                }
            });

            const sortedFeedback = allFeedback
                .filter(f => f.content.length > 5)
                .sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return a.rating - b.rating;
                });

            const container = document.getElementById('feedbackContent');
            container.innerHTML = '';

            if (sortedFeedback.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-comment-slash text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Tidak ada feedback yang tersedia</p>
                    </div>
                `;
                return;
            }

            sortedFeedback.forEach((feedback, index) => {
                const priorityClass = feedback.priority === 'high' ? 'from-red-50 to-pink-50 border-red-300' :
                                     feedback.priority === 'medium' ? 'from-orange-50 to-yellow-50 border-orange-300' :
                                     'from-blue-50 to-indigo-50 border-blue-300';

                const priorityIcon = feedback.priority === 'high' ? 'fas fa-exclamation-circle text-red-600' :
                                    feedback.priority === 'medium' ? 'fas fa-exclamation-triangle text-orange-600' :
                                    'fas fa-info-circle text-blue-600';

                const priorityLabel = feedback.priority === 'high' ? 'URGENT' :
                                     feedback.priority === 'medium' ? 'PENTING' : 'INFO';

                container.innerHTML += `
                    <div class="bg-gradient-to-r ${priorityClass} rounded-2xl p-6 border-2">
                        <div class="flex items-start space-x-4">
                            <div class="bg-white rounded-xl p-3 shadow-sm">
                                <i class="${priorityIcon} text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-bold text-gray-800">${feedback.responder}</span>
                                        <span class="bg-white/70 text-sm px-3 py-1 rounded-full font-medium">
                                            ${feedback.rating.toFixed(1)} â­
                                        </span>
                                        ${feedback.division ? `<span class="bg-gray-200 text-xs px-2 py-1 rounded-full">${feedback.division}</span>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-semibold text-gray-600">${feedback.type}</span>
                                        <span class="bg-white/70 text-xs px-2 py-1 rounded-full font-bold">${priorityLabel}</span>
                                    </div>
                                </div>
                                <p class="text-gray-800 leading-relaxed italic">"${feedback.content}"</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function refreshDashboard() {
            if (currentData.length > 0) {
                updateDashboard();
            }
        }

        async function exportToPDF() {
            if (currentData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            // Show loading
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF...';
            exportBtn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Set margins (narrow)
                const margin = 10;
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (margin * 2);
                
                let yPos = margin;

                // Calculate statistics
                const ratings = currentData.map(d => parseFloat(d.Rating)).filter(r => !isNaN(r));
                const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
                const internal = currentData.filter(d => d.Type && d.Type.toLowerCase().includes('internal')).length;
                const external = currentData.length - internal;
                const lowRatings = ratings.filter(r => r < 3).length;
                const highRatings = ratings.filter(r => r >= 4).length;

                // Header with maroon background
                doc.setFillColor(128, 0, 32); // Maroon color
                doc.rect(0, 0, pageWidth, 50, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(24);
                doc.text('LAPORAN EVALUASI', pageWidth/2, 20, { align: 'center' });
                doc.text('BUILDING MANAGEMENT', pageWidth/2, 30, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('Otoritas Jasa Keuangan - Daerah Istimewa Yogyakarta', pageWidth/2, 40, { align: 'center' });
                
                yPos = 60;

                // Date and time
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const now = new Date();
                doc.text(`Tanggal Laporan: ${now.toLocaleDateString('id-ID')} ${now.toLocaleTimeString('id-ID')}`, margin, yPos);
                yPos += 15;

                // Executive Summary
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(128, 0, 32);
                doc.text('I. RINGKASAN EKSEKUTIF', margin, yPos);
                yPos += 10;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                const summaryText = [
                    `Evaluasi building management OJK DIY telah dilaksanakan dengan melibatkan ${currentData.length} responden`,
                    `yang terdiri dari ${internal} responden internal (${((internal/currentData.length)*100).toFixed(1)}%) dan ${external} responden`,
                    `eksternal (${((external/currentData.length)*100).toFixed(1)}%). Rating rata-rata yang diperoleh adalah ${avgRating.toFixed(2)}/5.0,`,
                    `menunjukkan ${avgRating >= 4 ? 'kinerja yang sangat baik' : avgRating >= 3 ? 'kinerja yang cukup baik dengan ruang perbaikan' : 'kinerja yang memerlukan perhatian serius'}.`
                ];

                summaryText.forEach(line => {
                    const splitText = doc.splitTextToSize(line, contentWidth);
                    doc.text(splitText, margin, yPos);
                    yPos += splitText.length * 5;
                });

                yPos += 10;

                // Statistics Table
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(128, 0, 32);
                doc.text('II. STATISTIK EVALUASI', margin, yPos);
                yPos += 10;

                // Table header
                doc.setFillColor(128, 0, 32);
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('INDIKATOR', margin + 2, yPos + 5);
                doc.text('NILAI', margin + contentWidth - 30, yPos + 5);
                yPos += 8;

                // Table content
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                const statsData = [
                    ['Total Responden', currentData.length.toString()],
                    ['Rating Rata-rata', `${avgRating.toFixed(2)}/5.0`],
                    ['Responden Internal', `${internal} (${((internal/currentData.length)*100).toFixed(1)}%)`],
                    ['Responden Eksternal', `${external} (${((external/currentData.length)*100).toFixed(1)}%)`],
                    ['Kepuasan Tinggi (â¥4.0)', `${highRatings} (${((highRatings/ratings.length)*100).toFixed(1)}%)`],
                    ['Perlu Perhatian (<3.0)', `${lowRatings} (${((lowRatings/ratings.length)*100).toFixed(1)}%)`]
                ];

                statsData.forEach((row, index) => {
                    const bgColor = index % 2 === 0 ? 245 : 255;
                    doc.setFillColor(bgColor, bgColor, bgColor);
                    doc.rect(margin, yPos, contentWidth, 6, 'F');
                    doc.text(row[0], margin + 2, yPos + 4);
                    doc.text(row[1], margin + contentWidth - 30, yPos + 4);
                    yPos += 6;
                });

                yPos += 10;

                // Division Ranking
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(128, 0, 32);
                doc.text('III. RANKING DIVISI', margin, yPos);
                yPos += 10;

                // Calculate division ranking
                const divisionData = {};
                currentData.forEach(d => {
                    if (d.Division && d.Type && d.Type.toLowerCase().includes('internal')) {
                        const division = d.Division.trim();
                        if (!divisionData[division]) {
                            divisionData[division] = { name: division, ratings: [] };
                        }
                        const rating = parseFloat(d.Rating);
                        if (!isNaN(rating)) {
                            divisionData[division].ratings.push(rating);
                        }
                    }
                });

                const divisionRanking = Object.values(divisionData)
                    .map(div => ({
                        ...div,
                        avgRating: div.ratings.length > 0 ? 
                            div.ratings.reduce((a, b) => a + b, 0) / div.ratings.length : 0,
                        totalResponses: div.ratings.length
                    }))
                    .sort((a, b) => b.avgRating - a.avgRating);

                // Division table header
                doc.setFillColor(128, 0, 32);
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('RANK', margin + 2, yPos + 5);
                doc.text('DIVISI', margin + 20, yPos + 5);
                doc.text('RATING', margin + 120, yPos + 5);
                doc.text('RESPONDEN', margin + 150, yPos + 5);
                yPos += 8;

                // Division table content
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                divisionRanking.slice(0, 10).forEach((division, index) => {
                    const bgColor = index % 2 === 0 ? 245 : 255;
                    doc.setFillColor(bgColor, bgColor, bgColor);
                    doc.rect(margin, yPos, contentWidth, 6, 'F');
                    doc.text((index + 1).toString(), margin + 2, yPos + 4);
                    doc.text(division.name, margin + 20, yPos + 4);
                    doc.text(division.avgRating.toFixed(2), margin + 120, yPos + 4);
                    doc.text(division.totalResponses.toString(), margin + 150, yPos + 4);
                    yPos += 6;
                });

                // Check if we need a new page
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = margin;
                }

                yPos += 10;

                // Observasi dan Analisis
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(128, 0, 32);
                doc.text('IV. OBSERVASI DAN ANALISIS', margin, yPos);
                yPos += 10;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                const observations = [
                    'A. TEMUAN UTAMA:',
                    `â¢ Rating rata-rata ${avgRating.toFixed(2)} menunjukkan ${avgRating >= 4 ? 'performa excellent' : avgRating >= 3 ? 'performa baik dengan ruang perbaikan' : 'performa yang memerlukan perbaikan menyeluruh'}`,
                    `â¢ ${highRatings} responden (${((highRatings/ratings.length)*100).toFixed(1)}%) memberikan rating tinggi (â¥4.0)`,
                    `â¢ ${lowRatings} responden (${((lowRatings/ratings.length)*100).toFixed(1)}%) memberikan rating rendah (<3.0)`,
                    '',
                    'B. ANALISIS DIVISI:',
                    divisionRanking.length > 0 ? `â¢ Divisi terbaik: ${divisionRanking[0].name} (${divisionRanking[0].avgRating.toFixed(2)})` : 'â¢ Data divisi tidak tersedia',
                    divisionRanking.length > 1 ? `â¢ Divisi yang perlu perhatian: ${divisionRanking[divisionRanking.length-1].name} (${divisionRanking[divisionRanking.length-1].avgRating.toFixed(2)})` : '',
                    '',
                    'C. POLA RESPONS:',
                    `â¢ Partisipasi internal: ${((internal/currentData.length)*100).toFixed(1)}%`,
                    `â¢ Partisipasi eksternal: ${((external/currentData.length)*100).toFixed(1)}%`,
                    'â¢ Waktu respons menunjukkan antusiasme yang baik dari responden'
                ];

                observations.forEach(line => {
                    if (line.trim()) {
                        const splitText = doc.splitTextToSize(line, contentWidth);
                        doc.text(splitText, margin, yPos);
                        yPos += splitText.length * 5;
                    } else {
                        yPos += 3;
                    }
                });

                // Check if we need a new page
                if (yPos > pageHeight - 80) {
                    doc.addPage();
                    yPos = margin;
                }

                yPos += 10;

                // Kritik dan Saran
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(128, 0, 32);
                doc.text('V. KRITIK DAN SARAN RESPONDEN', margin, yPos);
                yPos += 10;

                // Get all feedback
                const allFeedback = [];
                currentData.forEach(d => {
                    if (d.Reason && d.Reason.trim()) {
                        allFeedback.push({
                            responder: d.Nama || 'Anonim',
                            division: d.Division || '',
                            rating: parseFloat(d.Rating) || 0,
                            content: d.Reason.trim(),
                            type: 'Alasan Rating'
                        });
                    }
                    if (d['Feedback Umum'] && d['Feedback Umum'].trim()) {
                        allFeedback.push({
                            responder: d.Nama || 'Anonim',
                            division: d.Division || '',
                            rating: parseFloat(d.Rating) || 0,
                            content: d['Feedback Umum'].trim(),
                            type: 'Saran Perbaikan'
                        });
                    }
                });

                const sortedFeedback = allFeedback
                    .filter(f => f.content.length > 5)
                    .sort((a, b) => a.rating - b.rating);

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                if (sortedFeedback.length === 0) {
                    doc.text('Tidak ada kritik dan saran yang tersedia.', margin, yPos);
                } else {
                    sortedFeedback.slice(0, 15).forEach((feedback, index) => {
                        // Check if we need a new page
                        if (yPos > pageHeight - 30) {
                            doc.addPage();
                            yPos = margin;
                        }

                        const priority = feedback.rating < 3 ? 'URGENT' : feedback.rating < 4 ? 'PENTING' : 'INFO';
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${feedback.responder} (${feedback.division}) - Rating: ${feedback.rating.toFixed(1)} [${priority}]`, margin, yPos);
                        yPos += 5;
                        
                        doc.setFont('helvetica', 'normal');
                        const feedbackText = doc.splitTextToSize(`"${feedback.content}"`, contentWidth - 5);
                        doc.text(feedbackText, margin + 3, yPos);
                        yPos += feedbackText.length * 4 + 3;
                    });
                }

                // Check if we need a new page
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = margin;
                }

                yPos += 10;

                // Rekomendasi
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(128, 0, 32);
                doc.text('VI. REKOMENDASI PERBAIKAN', margin, yPos);
                yPos += 10;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                const recommendations = [
                    'A. PRIORITAS TINGGI:',
                    'â¢ Perbaikan sistem AC dan ventilasi di seluruh gedung',
                    'â¢ Peningkatan kebersihan dan maintenance toilet',
                    'â¢ Perbaikan sistem lift yang sering bermasalah',
                    '',
                    'B. PRIORITAS SEDANG:',
                    'â¢ Perluasan area parkir untuk kendaraan',
                    'â¢ Pelatihan customer service untuk staff',
                    'â¢ Upgrade infrastruktur IT dan jaringan wifi',
                    '',
                    'C. PRIORITAS RENDAH:',
                    'â¢ Peningkatan variasi menu kantin',
                    'â¢ Perbaikan sound system ruang meeting',
                    'â¢ Penyederhanaan proses administrasi',
                    '',
                    'D. TINDAK LANJUT:',
                    'â¢ Evaluasi berkala setiap 3 bulan',
                    'â¢ Monitoring implementasi perbaikan',
                    'â¢ Feedback loop dengan responden'
                ];

                recommendations.forEach(line => {
                    if (line.trim()) {
                        const splitText = doc.splitTextToSize(line, contentWidth);
                        doc.text(splitText, margin, yPos);
                        yPos += splitText.length * 5;
                    } else {
                        yPos += 3;
                    }
                });

                // Footer
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Halaman ${i} dari ${totalPages}`, pageWidth - margin - 20, pageHeight - 5);
                    doc.text('Laporan Evaluasi Building Management OJK DIY', margin, pageHeight - 5);
                }

                // Save PDF
                const timestamp = new Date().toISOString().split('T')[0];
                doc.save(`Laporan_Evaluasi_Building_Management_OJK_DIY_${timestamp}.pdf`);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Terjadi kesalahan saat membuat PDF: ' + error.message);
            } finally {
                // Reset button
                exportBtn.innerHTML = '<i class="fas fa-file-pdf text-xl mr-2"></i><span>Download Laporan PDF</span>';
                exportBtn.disabled = false;
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97bb4c4d470b99a9',t:'MTc1NzMwMTUwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
